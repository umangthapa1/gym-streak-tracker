{% extends "base.html" %}
{% block page_nav %}
<header class="bg-white border-b border-slate-100 sticky top-16 z-40">
    <div class="max-w-4xl mx-auto px-4 py-4 flex items-center gap-4">
        <a href="/" class="w-10 h-10 rounded-xl bg-gradient-to-br from-indigo-500 to-purple-600 hover:from-indigo-600 hover:to-purple-700 flex items-center justify-center text-white transition-all hover:shadow-lg">
            <i class="fas fa-arrow-left"></i>
        </a>
        <div>
            <h1 class="text-lg font-bold text-slate-900">Admin Dashboard</h1>
            <p class="text-xs text-slate-500">Manage users, badges, and audits</p>
        </div>
        <a href="/logout" class="ml-auto px-4 py-2 rounded-xl border border-slate-200 hover:bg-slate-50 text-slate-700 font-semibold transition-all text-sm">
            <i class="fas fa-sign-out-alt mr-2"></i>Logout
        </a>
    </div>
</header>
{% endblock %}

{% block content %}
<div class="max-w-4xl mx-auto p-6">
    <div class="mb-4 flex items-center gap-3">
        <input id="audit-limit" type="number" class="border px-2 py-1 rounded w-20" value="20" />
        <button id="refresh-audit" class="px-3 py-1 rounded bg-indigo-600 text-white text-sm">Refresh Audit</button>
        <button id="export-csv" class="px-3 py-1 rounded bg-slate-200 text-slate-700 text-sm">Export Users CSV</button>
    </div>
    <table class="w-full table-auto border-collapse">
        <thead>
            <tr class="text-left">
                <th class="px-4 py-2">Username</th>
                <th class="px-4 py-2">Email</th>
                <th class="px-4 py-2">Workouts</th>
                <th class="px-4 py-2">Is Admin</th>
                <th class="px-4 py-2">Actions</th>
            </tr>
        </thead>
        <tbody>
            {% for u in users %}
            <tr id="user-row-{{ u.id }}" class="border-t">
                <td class="px-4 py-2">{{ u.username }}</td>
                <td class="px-4 py-2">{{ u.email }}</td>
                <td class="px-4 py-2">{{ u.workouts }}</td>
                <td class="px-4 py-2" id="user-admin-{{ u.id }}">{{ 'Yes' if u.is_admin else 'No' }}</td>
                <td class="px-4 py-2">
                    {% if not u.is_admin %}
                    <button class="promote-btn px-3 py-1 rounded bg-green-500 text-white text-sm" data-user-id="{{ u.id }}" data-current-admin="{{ '0' if not u.is_admin else '1' }}">Promote</button>
                    {% else %}
                    <button class="promote-btn px-3 py-1 rounded bg-amber-500 text-white text-sm" data-user-id="{{ u.id }}" data-current-admin="{{ '1' if u.is_admin else '0' }}">Revoke</button>
                    {% endif %}
                    <button class="reset-pw-btn px-3 py-1 rounded bg-rose-500 text-white text-sm ml-2" data-user-id="{{ u.id }}">Reset PW</button>
                    <button class="set-pw-btn px-3 py-1 rounded bg-rose-700 text-white text-sm ml-2" data-user-id="{{ u.id }}">Set PW</button>
                    <button class="regen-share-btn px-3 py-1 rounded bg-indigo-500 text-white text-sm ml-2" data-user-id="{{ u.id }}">Regenerate Share</button>
                    <button class="impersonate-btn px-3 py-1 rounded bg-slate-700 text-white text-sm ml-2" data-user-id="{{ u.id }}">Impersonate</button>
                    <select class="badge-select mx-2" data-user-id="{{ u.id }}">
                        <option value="">Select badge</option>
                    </select>
                    <button class="badge-action-btn px-3 py-1 rounded bg-emerald-500 text-white text-sm" data-user-id="{{ u.id }}">Award</button>
                    <button class="badge-revoke-btn px-3 py-1 rounded bg-amber-500 text-white text-sm ml-2" data-user-id="{{ u.id }}">Revoke</button>
                </td>
            </tr>
            {% endfor %}
        </tbody>
    </table>

    <h2 class="text-lg font-bold mt-8 mb-4">Audit Log</h2>
    <div id="audit-log" class="bg-white p-4 rounded border max-h-72 overflow-auto text-sm text-slate-700"></div>
</div>

<script>
// Handle promote/demote clicks
document.addEventListener('click', function (e) {
    if (e.target.classList.contains('promote-btn')) {
        const btn = e.target;
        const userId = btn.dataset.userId;
        const currentlyAdmin = btn.dataset.currentAdmin === '1';
        const makeAdmin = !currentlyAdmin;

        if (!confirm(`Are you sure you want to ${makeAdmin ? 'promote' : 'revoke'} admin for user ${userId}?`)) return;

        fetch('/api/admin/promote', {
            method: 'POST',
            credentials: 'same-origin',
            headers: {
                'Content-Type': 'application/json'
            },
            body: JSON.stringify({ user_id: userId, make_admin: makeAdmin })
        }).then(r => r.json()).then(data => {
            if (data && data.success) {
                const adminCell = document.getElementById(`user-admin-${userId}`);
                adminCell.textContent = data.is_admin ? 'Yes' : 'No';
                // Toggle button appearance and text
                btn.dataset.currentAdmin = data.is_admin ? '1' : '0';
                btn.textContent = data.is_admin ? 'Revoke' : 'Promote';
                btn.classList.toggle('bg-green-500', !data.is_admin);
                btn.classList.toggle('bg-amber-500', data.is_admin);
                alert('Updated successfully')
            } else {
                alert('Error: ' + (data && data.error ? data.error : 'Unknown'))
            }
        }).catch(err => {
            console.error(err);
            alert('Failed to contact server')
        });
    }

    if (e.target.classList.contains('reset-pw-btn')) {
        const userId = e.target.dataset.userId;
        if (!confirm('Reset password for user ' + userId + '?')) return;
        fetch('/api/admin/reset_password', {
            method: 'POST',
            credentials: 'same-origin',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ user_id: userId })
        }).then(r => r.json()).then(data => {
            if (data && data.temp_password) {
                showAppModal('Temporary password', `<p class="break-words"><strong>${data.temp_password}</strong></p><p class="text-xs text-slate-500 mt-2">Copy it now; it will not be shown again.</p>`);
            } else {
                showAppModal('Error', `<p>${(data && data.error ? data.error : 'Unknown')}</p>`)
            }
        }).catch(err => { console.error(err); showAppModal('Server error', '<p>Server error occurred</p>') });
    }

    if (e.target.classList.contains('regen-share-btn')) {
        const userId = e.target.dataset.userId;
        if (!confirm('Regenerate share token for user ' + userId + '?')) return;
        fetch('/api/admin/regenerate_share', {
            method: 'POST',
            credentials: 'same-origin',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ user_id: userId })
        }).then(r => r.json()).then(data => {
            if (data && data.share_token) {
                showAppModal('New share token', `<p class="break-words"><strong>${data.share_token}</strong></p><p class="text-xs text-slate-500 mt-2">Copy it now; it will not be shown again.</p>`);
            } else {
                showAppModal('Error', `<p>${(data && data.error ? data.error : 'Unknown')}</p>`)
            }
        }).catch(err => { console.error(err); showAppModal('Server error', '<p>Server error occurred</p>') });
    }

    if (e.target.classList.contains('set-pw-btn')) {
        const userId = e.target.dataset.userId;
        const newpw = prompt('Enter new password for user ' + userId + ' (min 6 chars):');
        if (!newpw) return;
        fetch('/api/admin/set_password', {
            method: 'POST',
            credentials: 'same-origin',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ user_id: userId, new_password: newpw })
        }).then(r => r.json()).then(data => {
            if (data && data.success) {
                showAppModal('Password set', `<p>New password set successfully.</p>`);
            } else {
                showAppModal('Error', `<p>${(data && data.error ? data.error : 'Unknown')}</p>`)
            }
        }).catch(err => { console.error(err); showAppModal('Server error', '<p>Server error occurred</p>') });
    }

    if (e.target.classList.contains('badge-action-btn')) {
        const userId = e.target.dataset.userId;
        const select = document.querySelector(`.badge-select[data-user-id='${userId}']`);
        const key = select.value;
        if (!key) return alert('Select a badge');
        fetch('/api/admin/badge', {
            method: 'POST',
            credentials: 'same-origin',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ user_id: userId, action: 'award', badge_key: key })
        }).then(r => r.json()).then(data => {
            if (data && data.success) alert('Awarded'); else alert('Error: ' + (data && data.error?data.error:'Unknown'))
        }).catch(err => { console.error(err); alert('Server error') });
    }

    if (e.target.classList.contains('badge-revoke-btn')) {
        const userId = e.target.dataset.userId;
        const select = document.querySelector(`.badge-select[data-user-id='${userId}']`);
        const key = select.value;
        if (!key) return alert('Select a badge');
        fetch('/api/admin/badge', {
            method: 'POST',
            credentials: 'same-origin',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ user_id: userId, action: 'revoke', badge_key: key })
        }).then(r => r.json()).then(data => {
            if (data && data.success) alert('Revoked'); else alert('Error: ' + (data && data.error?data.error:'Unknown'))
        }).catch(err => { console.error(err); alert('Server error') });
    }

    if (e.target.classList.contains('impersonate-btn')) {
        const userId = e.target.dataset.userId;
        if (!confirm('Start impersonating user ' + userId + '?')) return;
        fetch('/api/admin/impersonate', {
            method: 'POST',
            credentials: 'same-origin',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ user_id: userId })
        }).then(r => r.json()).then(data => {
            if (data && data.success) {
                showAppModal('Impersonation started', `<p>Now impersonating <strong>${data.username}</strong>. You will be returned to the original admin when you click <em>Stop Impersonation</em> in the banner.</p>`);
                // reload to reflect impersonated user's view
                setTimeout(()=>location.reload(), 1200);
            } else {
                showAppModal('Error', `<p>${(data && data.error?data.error:'Unknown')}</p>`)
            }
        }).catch(err => { console.error(err); showAppModal('Server error', '<p>Server error occurred</p>') });
    }

    // Stop impersonation handler (banner button in base.html)
    const stopBtn = document.getElementById('stop-impersonate-btn');
    if (stopBtn) {
        stopBtn.addEventListener('click', function() {
            if (!confirm('Stop impersonation and return to admin?')) return;
            fetch('/api/admin/stop_impersonate', { method: 'POST', credentials: 'same-origin' }).then(r=>r.json()).then(d=>{
                if (d && d.success) {
                    showAppModal('Impersonation stopped', '<p>Returned to admin account.</p>');
                    setTimeout(()=>location.reload(),800);
                } else {
                    showAppModal('Error', '<p>Failed to stop impersonation</p>');
                }
            }).catch(err=>{ console.error(err); showAppModal('Server error','<p>Server error occurred</p>') });
        });
    }
});

// Populate badge selects and audit log
(async function initAdmin() {
    try {
        const resp = await fetch('/api/badges');
        const body = await resp.json();
        const badges = body.badges || [];
        document.querySelectorAll('.badge-select').forEach(sel => {
            badges.forEach(b => {
                const opt = document.createElement('option');
                opt.value = b.key;
                opt.textContent = b.name;
                sel.appendChild(opt);
            });
        });
        // load audit
        await loadAudit();
    } catch (err) { console.error(err) }
})();

async function loadAudit() {
    const limit = document.getElementById('audit-limit').value || 20;
    const r = await fetch(`/api/admin/audit?limit=${limit}`);
    const j = await r.json();
    const container = document.getElementById('audit-log');
    container.innerHTML = '';
    (j.logs || []).forEach(l => {
        const div = document.createElement('div');
        div.className = 'py-1 border-b last:border-b-0';
        div.textContent = `${l.created_at} [actor:${l.actor_id}] ${l.action} ${l.details || ''}`;
        container.appendChild(div);
    });
}

document.getElementById('refresh-audit').addEventListener('click', loadAudit);
document.getElementById('export-csv').addEventListener('click', function() {
    // simple export
    const rows = Array.from(document.querySelectorAll('tbody tr')).map(tr => {
        return Array.from(tr.querySelectorAll('td')).slice(0,3).map(td=>`"${td.textContent.replace(/"/g,'""')}"`).join(',');
    });
    const csv = 'username,email,workouts\n' + rows.join('\n');
    const blob = new Blob([csv], {type: 'text/csv'});
    const url = URL.createObjectURL(blob);
    const a = document.createElement('a'); a.href = url; a.download = 'users.csv'; a.click();
});
</script>

{% endblock %}